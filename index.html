<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Krshn - Your Bhagavad Gita Assistant</title>
    <!-- All SEO Meta Tags are the same -->
    <style>
        /* All CSS from the previous version is exactly the same */
        :root {
            --bg-color: #FDF5E6; --primary-color: #FF9933; --text-color: #4A2E2C;
            --header-footer-bg: #FFFBF2; --user-msg-bg: #E0E0E0; --bot-msg-bg: #FFFFFF;
            --font-family: 'Poppins', sans-serif; --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Tiro+Devanagari+Sanskrit&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; min-height: 100%; }
        #app-container { display: flex; flex-direction: column; flex-grow: 1; width: 100%; max-width: 768px; margin: 0 auto; background-color: var(--header-footer-bg); }
        header { padding: 15px 20px; text-align: center; font-size: 1.5em; font-weight: 600; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08); z-index: 10; }
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background-color: var(--bg-color); }
        #chat-window { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 80%; padding: 12px 18px; border-radius: 20px; line-height: 1.6; word-wrap: break-word; }
        .user-message { background-color: var(--user-msg-bg); align-self: flex-end; border-bottom-right-radius: 5px; }
        .bot-message { background-color: var(--bot-msg-bg); align-self: flex-start; border-bottom-left-radius: 5px; box-shadow: var(--box-shadow); position: relative; }
        .bot-message .shlok { font-family: 'Tiro Devanagari Sanskrit', serif; font-size: 1.1em; color: var(--primary-color); margin: 10px 0; padding: 10px; background: #FFFBF2; border-left: 3px solid var(--primary-color); border-radius: 5px; }
        #chat-form { display: flex; padding: 15px; border-top: 1px solid #ddd; }
        #message-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 25px; padding: 12px 20px; font-size: 1em; outline: none; }
        #chat-form button { background: var(--primary-color); border: none; border-radius: 50%; width: 50px; height: 50px; margin-left: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #chat-form button svg { width: 24px; height: 24px; fill: white; }
        footer { text-align: center; padding: 10px; }
        footer button { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 8px 15px; margin: 0 5px; border-radius: 20px; cursor: pointer; font-size: 0.9em; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; text-align: center; position: relative; }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        #donate-qr-image { max-width: 80%; height: auto; margin-top: 15px; }
        #feedback-textarea { width: 100%; min-height: 100px; margin-top: 15px; padding: 10px; }
        .modal-content button { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>
    <!-- The HTML structure is the same, including header, chat-container, and modals -->
    <div id="app-container">
        <header>Ask Krshn</header>
        <div id="chat-container">
            <div id="chat-window"><div class="message bot-message">Pranam! Ask me any question about life, karma, or purpose, and I shall find a relevant verse from the timeless wisdom of the Bhagavad Gita for you.</div></div>
            <form id="chat-form"><input type="text" id="message-input" placeholder="Ask about 'karma', 'dharma', 'life'..." autocomplete="off" required><button type="submit" aria-label="Send Message"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg></button></form>
        </div>
        <footer><button id="export-pdf-btn">Download Chat</button><button id="donate-btn">Donate</button><button id="feedback-btn">Feedback</button></footer>
    </div>
    <div id="donate-modal" class="modal"><div class="modal-content"><span class="close-btn" data-modal="donate-modal">&times;</span><h2>Support the Mission</h2><p>Your contribution helps maintain this service. Thank you!</p><img id="donate-qr-image" src="" alt="Scan to donate"></div></div>
    <div id="feedback-modal" class="modal"><div class="modal-content"><span class="close-btn" data-modal="feedback-modal">&times;</span><h2>Share Your Feedback</h2><p>What new features or improvements would you like to see?</p><textarea id="feedback-textarea" placeholder="Your valuable suggestions..."></textarea><button id="submit-feedback-btn">Submit Feedback</button></div></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
  apiKey: "AIzaSyCqQqJWMl3naW8Ad8_lpoFQyuzSjTJs8N8",
  authDomain: "skater-13f74.firebaseapp.com",
  databaseURL: "https://skater-13f74-default-rtdb.firebaseio.com",
  projectId: "skater-13f74",
  storageBucket: "skater-13f74.firebasestorage.app",
  messagingSenderId: "750747470830",
  appId: "1:750747470830:web:2deefa64a23e45d3ae9cff"
};
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let gitaDataContext = null;
        let greetingsData = {};
        let chapterDescriptions = {}; // NEW: To store chapter summaries

        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        
        const hinglishKeywords = new Set(['kya', 'hai', 'kaise', 'kyun', 'mein', 'mera', 'mujhe', 'aap', 'ka', 'ki', 'ko', 'aur', 'nahi', 'hoon', 'karna', 'chahiye', 'matlab']);
        const stopWords = new Set(['i', 'me', 'my', 'a', 'an', 'the', 'is', 'am', 'are', 'what', 'who', 'how', 'when', 'where', 'why', 'should', 'do', 'without', 'about', 'to', 'for', 'of', 'in', 'on', 'please', 'tell', 'can', 'you']);

        function getKeywords(text) {
            const lowerText = text.toLowerCase().replace(/[^\w\s]/g, '');
            return new Set(lowerText.split(/\s+/).filter(word => !stopWords.has(word) && word.length > 2));
        }

        function detectLanguage(text) {
            const words = text.toLowerCase().split(/\s+/);
            for (const word of words) {
                if (hinglishKeywords.has(word)) return 'hinglish';
            }
            return 'english';
        }

        // --- NEW: Two-Step Search Logic ---
        function findBestChapter(keywords) {
            if (!chapterDescriptions) return null;
            let bestChapterKey = null;
            let maxScore = 0;
            for (const chapterKey in chapterDescriptions) {
                const description = chapterDescriptions[chapterKey].toLowerCase();
                let currentScore = 0;
                keywords.forEach(keyword => {
                    if (description.includes(keyword)) currentScore++;
                });
                if (currentScore > maxScore) {
                    maxScore = currentScore;
                    bestChapterKey = chapterKey;
                }
            }
            return bestChapterKey;
        }

        function findBestShlok(keywords, chapterKey = null) {
            const searchScope = chapterKey ? { [chapterKey]: gitaDataContext[chapterKey] } : gitaDataContext;
            if (!searchScope) return null;

            let bestMatch = null;
            let maxScore = 0;

            for (const chapKey in searchScope) {
                const verses = searchScope[chapKey];
                for (const verseKey in verses) {
                    const verse = verses[verseKey];
                    const content = `${verse.shlok} ${verse.explanation_hin || ''} ${verse.explanation_eng || ''}`.toLowerCase();
                    let matchedKeywords = new Set();
                    keywords.forEach(keyword => {
                        if (content.includes(keyword)) matchedKeywords.add(keyword);
                    });
                    if (matchedKeywords.size > 0) {
                        let currentScore = matchedKeywords.size;
                        if (currentScore > maxScore) {
                            maxScore = currentScore;
                            bestMatch = { ...verse, chapter: chapKey.replace('chapter_', ''), verse: verseKey.replace('verse_', '') };
                        }
                    }
                }
            }
            return bestMatch;
        }
        
        function findGreeting(userMessage) {
            const lowerUserMessage = userMessage.toLowerCase();
            for (const trigger in greetingsData) {
                if (lowerUserMessage.includes(trigger)) return greetingsData[trigger];
            }
            return null;
        }
        
        function displayMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${sender}-message`);
            if (sender === 'bot') { messageDiv.innerHTML = text; } else { messageDiv.textContent = text; }
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function fetchInitialData() {
            try {
                const shloksSnapshot = await get(ref(database, 'shloks'));
                if (shloksSnapshot.exists()) gitaDataContext = shloksSnapshot.val();

                const metaSnapshot = await get(ref(database, 'meta'));
                if (metaSnapshot.exists()) {
                    const meta = metaSnapshot.val();
                    if(meta.donateQrUrl) document.getElementById('donate-qr-image').src = meta.donateQrUrl;
                    if(meta.chapter_descriptions) chapterDescriptions = meta.chapter_descriptions;
                }

                const greetingsSnapshot = await get(ref(database, 'greetings'));
                if (greetingsSnapshot.exists()) {
                    const rawGreetings = greetingsSnapshot.val();
                    for (const key in rawGreetings) {
                        greetingsData[rawGreetings[key].trigger.toLowerCase()] = rawGreetings[key].reply;
                    }
                }
            } catch (error) {
                console.error("Error fetching data:", error);
                displayMessage("Sorry, I am unable to access the knowledge base.", "bot");
            }
        }
        
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            displayMessage(userMessage, 'user');
            messageInput.value = '';
            
            const greetingReply = findGreeting(userMessage);
            if (greetingReply) {
                setTimeout(() => displayMessage(greetingReply, 'bot'), 300);
                return;
            }

            const keywords = getKeywords(userMessage);
            if (keywords.size === 0) {
                setTimeout(() => displayMessage("Please ask a more specific question.", "bot"), 300);
                return;
            }

            // --- ADVANCED LOGIC IN ACTION ---
            const bestChapterKey = findBestChapter(keywords);
            const bestMatch = findBestShlok(keywords, bestChapterKey);

            setTimeout(() => {
                if (bestMatch) {
                    const detectedLang = detectLanguage(userMessage);
                    const explanation = (detectedLang === 'english' && bestMatch.explanation_eng) ? bestMatch.explanation_eng : (bestMatch.explanation_hin || bestMatch.explanation_eng);
                    
                    const sanitizedUserMessage = userMessage.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    let introText = `A relevant verse is found in <strong>Chapter ${bestMatch.chapter}, Verse ${bestMatch.verse}</strong>:`;
                    if (bestChapterKey) {
                        introText = `Your question appears to relate to the theme of Chapter ${bestMatch.chapter}. Within this context, <strong>Verse ${bestMatch.verse}</strong> offers guidance:`;
                    }

                    const botResponse = `
                        <p>You asked: "<em>${sanitizedUserMessage}</em>"</p>
                        <p>${introText}</p>
                        <div class="shlok">${bestMatch.shlok}</div>
                        <p><b>Guidance from this verse:</b></p>
                        <p>${explanation || 'Explanation not available.'}</p>
                    `;
                    displayMessage(botResponse, 'bot');
                } else {
                    const noMatchResponse = `I couldn't find a specific verse for your query. Please try different keywords (e.g., karma, mind, soul).`;
                    displayMessage(noMatchResponse, 'bot');
                }
            }, 300);
        });

        // The rest of the event listeners (Modals, PDF export) are the same
        const donateBtn = document.getElementById('donate-btn'); const feedbackBtn = document.getElementById('feedback-btn'); const exportPdfBtn = document.getElementById('export-pdf-btn'); const donateModal = document.getElementById('donate-modal'); const feedbackModal = document.getElementById('feedback-modal'); const closeBtns = document.querySelectorAll('.close-btn'); const submitFeedbackBtn = document.getElementById('submit-feedback-btn');
        donateBtn.addEventListener('click', () => { donateModal.style.display = 'flex'; });
        feedbackBtn.addEventListener('click', () => { feedbackModal.style.display = 'flex'; });
        closeBtns.forEach(btn => { btn.addEventListener('click', () => { document.getElementById(btn.dataset.modal).style.display = 'none'; }); });
        submitFeedbackBtn.addEventListener('click', async () => { const feedbackText = document.getElementById('feedback-textarea').value.trim(); if (feedbackText.length < 10) return alert("Please provide a more detailed feedback."); try { await push(ref(db, 'feedback'), { feedback: feedbackText, timestamp: new Date().toISOString() }); alert("Thank you for your valuable feedback!"); document.getElementById('feedback-textarea').value = ''; feedbackModal.style.display = 'none'; } catch (error) { console.error("Error sending feedback:", error); alert("Sorry, couldn't send feedback."); } });
        exportPdfBtn.addEventListener('click', () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = 15; const margin = 10; const maxWidth = 180; doc.setFontSize(18); doc.text("Ask Krshn - Chat History", margin, y); y += 15; doc.setFontSize(12); const messages = chatWindow.querySelectorAll('.message'); if(messages.length <= 1) return alert("Chat is empty. Please ask a question first."); messages.forEach(message => { if(y > 280) { doc.addPage(); y = 15; } const isUser = message.classList.contains('user-message'); const title = isUser ? "You:" : "Ask Krshn:"; const text = message.innerText; doc.setFont(undefined, 'bold'); doc.text(title, margin, y); y += 6; doc.setFont(undefined, 'normal'); const textLines = doc.splitTextToSize(text, maxWidth); doc.text(textLines, margin, y); y += (textLines.length * 5) + 10; }); doc.save("Ask-Krshn-Chat.pdf"); });
        
        document.addEventListener('DOMContentLoaded', fetchInitialData);
    </script>
</body>
</html>
